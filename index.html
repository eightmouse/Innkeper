<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Innkeeper</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Exo+2:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="app">

  <!-- â”€â”€ Title / Menu Bar (combined) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="titlebar">
    <div id="titlebar-left">
      <span id="titlebar-title">INNKEEPER</span>
      <div id="menubar">
        <div class="menu-item">Settings</div>
        <div class="menu-item">Info</div>
      </div>
    </div>
    <div id="window-controls">
      <button class="win-btn min"   id="btn-min"   title="Minimize">&#x2212;</button>
      <button class="win-btn max"   id="btn-max"   title="Maximize">&#x25A1;</button>
      <button class="win-btn close" id="btn-close" title="Close">&#x2715;</button>
    </div>
  </div>

  <!-- â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="content">
    <div id="empty-state">
      <div class="empty-icon">âš”ï¸</div>
      <p>No characters yet â€” click + to add one</p>
    </div>
    <div id="character-grid"></div>
  </div>

</div>

<!-- â”€â”€ Add Character Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<button id="add-btn" title="Add Character">+</button>

<!-- â”€â”€ Add Character Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="add-modal" class="modal-overlay">
  <div class="modal">
    <h2>Add Character</h2>
    <div class="form-group">
      <label>Character Name</label>
      <input type="text" id="input-name" placeholder="e.g. Arthas" autocomplete="off" />
    </div>
    <div class="form-group">
      <label>Realm <span style="font-weight:300; text-transform:none; letter-spacing:0; color: var(--text-muted); opacity:0.7;">(leave blank to search all)</span></label>
      <input type="text" id="input-realm" placeholder="e.g. Silvermoon" autocomplete="off" />
    </div>
    <div class="form-group">
      <label>Region</label>
      <select id="input-region">
        <option value="eu">EU</option>
        <option value="us">US</option>
        <option value="kr">KR</option>
        <option value="tw">TW</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
      <button class="btn btn-primary"   id="modal-submit">Search & Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Info Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="info-modal" class="modal-overlay">
  <div class="modal">
    <h2>About Innkeeper</h2>
    <div class="info-body">
      <p class="info-line">Track your WoW characters' weekly and daily activities across realms.</p>
      <div class="info-divider"></div>
      <div class="info-row">
        <span class="info-label">Author</span>
        <span class="info-value">Eightmouse</span>
      </div>
      <div class="info-row">
        <span class="info-label">GitHub</span>
        <!-- â†“ Update this href to your GitHub URL -->
        <a class="info-link" id="github-link" href="https://github.com/eightmouse" target="_blank">github.com/eightmouse</a>
      </div>
      <div class="info-row">
        <span class="info-label">Version</span>
        <span class="info-value">0.8</span>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="info-close">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Delete Confirm Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="delete-modal" class="modal-overlay">
  <div class="modal">
    <h2>Remove Character</h2>
    <p id="delete-modal-msg" style="font-size:13px; color: var(--text-muted); margin-bottom:20px; line-height:1.5;"></p>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="delete-cancel">Cancel</button>
      <button class="btn btn-danger"    id="delete-confirm">Remove</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Character Detail Modal (centered) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="detail-overlay" class="modal-overlay">
  <div id="detail-modal">
    <div class="detail-banner" id="detail-banner">
      <button class="detail-close" id="detail-close">âœ•</button>
      <div class="detail-identity">
        <div class="detail-name" id="detail-name">â€”</div>
        <div class="detail-sub"  id="detail-sub">â€”</div>
      </div>
    </div>
    <div class="detail-body">
      <div class="detail-section-title">Activities</div>
      <div id="detail-activities"></div>
      <div class="reset-info">
        <div class="detail-section-title" style="margin-bottom:8px; border:none; padding:0;">Reset Timers</div>
        <div class="reset-row">
          <span class="reset-label">Daily reset</span>
          <span class="reset-value" id="reset-daily">â€”</span>
        </div>
        <div class="reset-row">
          <span class="reset-label">Weekly reset</span>
          <span class="reset-value" id="reset-weekly">â€”</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast"></div>

<script>
'use strict';

// â”€â”€ IPC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ipcRenderer;
try {
  ({ ipcRenderer } = require('electron'));
} catch (e) {
  console.warn('No Electron IPC â€” browser preview mode');
}

function sendToPython(cmd) {
  if (ipcRenderer) {
    ipcRenderer.send('to-python', cmd);
  } else {
    console.log('[â†’ Python mock]', cmd);
  }
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let characters = [];
let detailIndex = null;
let pendingDeleteIndex = null;

// â”€â”€ Activity metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACTIVITY_META = {
  'Raid':         { icon: 'âš”ï¸' },
  'Mythic+':      { icon: 'ğŸ”‘' },
  'Expeditions':  { icon: 'ğŸ—ºï¸' },
  'World Quests': { icon: 'ğŸ“œ' },
};

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, isError = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className   = 'show' + (isError ? ' error' : '');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.className = '', isError ? 5000 : 2800);
}

// â”€â”€ Reset timer helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getNextReset(type) {
  const now  = new Date();
  const next = new Date(now);
  next.setUTCHours(8, 0, 0, 0);

  if (type === 'daily') {
    if (now >= next) next.setUTCDate(next.getUTCDate() + 1);
  } else {
    // Wednesday 08:00 UTC
    const daysUntil = (3 - now.getUTCDay() + 7) % 7 || 7;
    next.setUTCDate(next.getUTCDate() + daysUntil);
    if (now.getUTCDay() === 3 && now >= next) next.setUTCDate(next.getUTCDate() + 7);
  }
  return next;
}

function formatTimeUntil(date) {
  const diff = date - Date.now();
  if (diff <= 0) return { text: 'Now',    cls: 'now' };
  const h    = Math.floor(diff / 3600000);
  const m    = Math.floor((diff % 3600000) / 60000);
  const text = h > 0 ? `${h}h ${m}m` : `${m}m`;
  return { text, cls: h < 2 ? 'soon' : '' };
}

// â”€â”€ Render Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid() {
  const grid  = document.getElementById('character-grid');
  const empty = document.getElementById('empty-state');
  grid.innerHTML = '';

  if (!characters.length) {
    empty.classList.add('visible');
    return;
  }
  empty.classList.remove('visible');

  characters.forEach((char, idx) => {
    const card = document.createElement('div');
    card.className = 'char-card';

    const hasPortrait   = !!char.portrait_url;
    const portraitStyle = hasPortrait ? `background-image:url('${char.portrait_url}');` : '';
    const pips = Object.entries(char.activities || {}).map(([name, data]) =>
      `<div class="activity-pip ${data.status === 'completed' ? 'done' : 'available'}" title="${name}"></div>`
    ).join('');

    card.innerHTML = `
      <div class="card-portrait ${hasPortrait ? '' : 'placeholder'}" style="${portraitStyle}">
        ${hasPortrait ? '' : '<div class="placeholder-icon">ğŸ§™</div>'}
      </div>
      <button class="card-close" title="Remove">âœ•</button>
      <div class="card-info">
        <div class="card-name">${char.name} (${char.level})</div>
        <div class="card-realm">${char.realm}</div>
        <div class="card-activities">${pips}</div>
      </div>
    `;

    card.querySelector('.card-close').addEventListener('click', (e) => {
      e.stopPropagation();
      openDeleteModal(idx);
    });

    card.addEventListener('click', () => openDetail(idx));
    grid.appendChild(card);
  });
}

// â”€â”€ Detail Modal (centered) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetail(idx) {
  detailIndex = idx;
  const char    = characters[idx];
  const overlay = document.getElementById('detail-overlay');
  const banner  = document.getElementById('detail-banner');

  if (char.portrait_url) {
    banner.style.backgroundImage = `url('${char.portrait_url}')`;
    banner.classList.remove('placeholder');
  } else {
    banner.style.backgroundImage = '';
    banner.classList.add('placeholder');
  }

  document.getElementById('detail-name').textContent = `${char.name} (${char.level})`;
  document.getElementById('detail-sub').textContent  = char.realm;

  const actList = document.getElementById('detail-activities');
  actList.innerHTML = '';
  Object.entries(char.activities || {}).forEach(([name, data]) => {
    const icon    = (ACTIVITY_META[name] || {}).icon || 'â€¢';
    const checked = data.status === 'completed';
    const row = document.createElement('div');
    row.className = 'activity-row';
    row.dataset.activity = name;
    row.innerHTML = `
      <div class="activity-row-left">
        <span class="activity-icon">${icon}</span>
        <span class="activity-label">${name}</span>
        <span class="activity-reset-tag">${data.reset}</span>
      </div>
      <label class="toggle">
        <input type="checkbox" ${checked ? 'checked' : ''} />
        <div class="toggle-slider"></div>
      </label>
    `;
    row.querySelector('input').addEventListener('change', (e) => {
      toggleActivity(idx, name, e.target.checked);
    });
    actList.appendChild(row);
  });

  updateResetTimers();
  overlay.classList.add('open');
}

function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('open');
  detailIndex = null;
}

function updateResetTimers() {
  ['daily', 'weekly'].forEach(type => {
    const { text, cls } = formatTimeUntil(getNextReset(type));
    const el = document.getElementById(`reset-${type}`);
    el.textContent = text;
    el.className   = 'reset-value ' + cls;
  });
}

setInterval(() => { if (detailIndex !== null) updateResetTimers(); }, 60000);

// â”€â”€ Toggle Activity â€” surgical update, no full re-render â”€â”€
function toggleActivity(charIdx, activityName, isDone) {
  const char = characters[charIdx];
  if (!char?.activities[activityName]) return;
  char.activities[activityName].status = isDone ? 'completed' : 'available';

  // 1. Update only the matching pip on the card (no renderGrid)
  const card = document.querySelector(`#character-grid .char-card:nth-child(${charIdx + 1})`);
  if (card) {
    const pips = card.querySelectorAll('.activity-pip');
    const actKeys = Object.keys(char.activities);
    const pipIdx  = actKeys.indexOf(activityName);
    if (pips[pipIdx]) {
      pips[pipIdx].className = `activity-pip ${isDone ? 'done' : 'available'}`;
    }
  }

  // 2. No need to touch the modal â€” the checkbox already reflects the new state

  sendToPython(`TOGGLE_ACTIVITY:${char.name}:${char.realm}:${activityName}`);
}

// â”€â”€ Delete Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDeleteModal(idx) {
  pendingDeleteIndex = idx;
  const char = characters[idx];
  document.getElementById('delete-modal-msg').textContent =
    `Remove ${char.name} from ${char.realm}? This cannot be undone.`;
  document.getElementById('delete-modal').classList.add('open');
}

document.getElementById('delete-cancel').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.remove('open');
  pendingDeleteIndex = null;
});

document.getElementById('delete-confirm').addEventListener('click', () => {
  if (pendingDeleteIndex === null) return;
  const char = characters[pendingDeleteIndex];
  sendToPython(`DELETE_CHARACTER:${char.name}:${char.realm}`);
  if (detailIndex === pendingDeleteIndex) closeDetail();
  characters.splice(pendingDeleteIndex, 1);
  pendingDeleteIndex = null;
  document.getElementById('delete-modal').classList.remove('open');
  renderGrid();
  showToast(`${char.name} removed`);
});

// â”€â”€ Add Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const addModal    = document.getElementById('add-modal');
const inputName   = document.getElementById('input-name');
const inputRegion = document.getElementById('input-region');

document.getElementById('add-btn').addEventListener('click', () => {
  addModal.classList.add('open');
  inputName.focus();
});

function closeAddModal() {
  addModal.classList.remove('open');
  inputName.value = '';
}

document.getElementById('modal-cancel').addEventListener('click', closeAddModal);
addModal.addEventListener('click', (e) => { if (e.target === addModal) closeAddModal(); });

document.getElementById('modal-submit').addEventListener('click', () => {
  const name   = inputName.value.trim();
  const realm  = document.getElementById('input-realm').value.trim();
  const region = inputRegion.value;
  if (!name) {
    inputName.focus();
    return;
  }

  const submitBtn = document.getElementById('modal-submit');
  submitBtn.textContent = 'Searchingâ€¦';
  submitBtn.disabled = true;

  if (realm) {
    showToast(`Looking up ${name} on ${realm} (${region.toUpperCase()})â€¦`);
    sendToPython(`ADD_CHARACTER:${region}:${realm}:${name}`);
  } else {
    showToast(`Scanning all ${region.toUpperCase()} realms for ${name}â€¦ (may take a few minutes)`);
    sendToPython(`AUTO_ADD:${region}:${name}`);
  }
  closeAddModal();
  // Re-enable after a delay in case the response never arrives
  setTimeout(() => { submitBtn.textContent = 'Search & Add'; submitBtn.disabled = false; }, 500);
});

inputName.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('modal-submit').click();
});

// â”€â”€ Info Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.menu-item').forEach(item => {
  if (item.textContent.trim() === 'Info') {
    item.addEventListener('click', () => {
      document.getElementById('info-modal').classList.add('open');
    });
  }
});
document.getElementById('info-close').addEventListener('click', () => {
  document.getElementById('info-modal').classList.remove('open');
});
document.getElementById('info-modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('info-modal'))
    document.getElementById('info-modal').classList.remove('open');
});

// Open GitHub link in real browser (not inside Electron)
document.getElementById('github-link').addEventListener('click', (e) => {
  e.preventDefault();
  const url = e.currentTarget.href;
  if (ipcRenderer) {
    ipcRenderer.send('open-external', url);
  } else {
    window.open(url, '_blank');
  }
});

// â”€â”€ Detail close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('detail-close').addEventListener('click', closeDetail);
document.getElementById('detail-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('detail-overlay')) closeDetail();
});

// â”€â”€ Window Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (ipcRenderer) {
  document.getElementById('btn-close').addEventListener('click', () => ipcRenderer.send('window-close'));
  document.getElementById('btn-min').addEventListener('click',   () => ipcRenderer.send('window-minimize'));
  document.getElementById('btn-max').addEventListener('click',   () => ipcRenderer.send('window-maximize'));
}

// â”€â”€ Receive from Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (ipcRenderer) {
  ipcRenderer.on('from-python', (event, raw) => {
    try {
      const data = JSON.parse(raw);
      if (Array.isArray(data)) {
        characters = data;
        renderGrid();
        return;
      }
      if (data.status === 'added') {
        characters.push(data.character);
        renderGrid();
        showToast(`${data.character.name} added!`);
      } else if (data.status === 'not_found') {
        showToast('Character not found â€” check the name?', true);
      } else if (data.status === 'error') {
        showToast(data.message || 'Something went wrong', true);
      }
    } catch (e) {
      console.error('from-python parse error:', e);
    }
  });
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderGrid();
</script>
</body>
</html>